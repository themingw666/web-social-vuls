import fs from 'fs'
import path from "path"
import { fileURLToPath } from 'url';
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

let responseHead = `HTTP/1.1 200 OK
Content-Type: text/html; charset=UTF-8`
let responseFile = '/exploit/view'
let responseBody = 'Hello, world!'

const get = (req,res) => {
    res.render('exploit', {layout: false , responseHead, responseFile, responseBody})
}

const post = (req,res) => {
    responseHead = req.body.responseHead
    responseFile = req.body.responseFile
    responseBody = req.body.responseBody
    let formAction = req.body.formAction
    if (formAction === 'ACCESS_LOG') {
        res.redirect(302, "/access-log")
        return;
    }
    if (formAction === 'VIEW_EXPLOIT') {
        res.redirect(302, responseFile)
        return;
    } else {
        res.redirect(302, "/exploit")
        res.end()
    }
}

const clearlog = (req,res) => {
    let formAction = req.body.formAction
    if (formAction === 'CLEAR_LOG') {
        fs.createWriteStream(path.join(__dirname, '../public/access.log'), { flags: 'w' })
        res.redirect(302, "/access-log")
        return;
    }
}

const ex = (req,res) => {
    if ("/exploit"+req.path !== responseFile) {
        res.status(404).send();
        return;
    }
    const responseMessage = `${responseHead}

    ${responseBody}

    `
    res.socket.end(responseMessage)
}

export default {get, post, clearlog, ex}